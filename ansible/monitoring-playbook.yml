- hosts: group_Name_master
  become: true
  gather_facts: true
  tasks:
    - name: Install required packages
      apt:
        name:
          - curl
          - software-properties-common
          - kubectl
        state: present
        update_cache: yes

    - name: Add Prometheus Helm repository
      command: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

    - name: Add Grafana Helm repository
      command: helm repo add grafana https://grafana.github.io/helm-charts

    - name: Update Helm repositories
      command: helm repo update

    - name: Deploy Prometheus Helm chart
      command: helm upgrade --install prometheus prometheus-community/prometheus --create-namespace --kubeconfig /home/ubuntu/.kube/config

    - name: Deploy Grafana Helm chart
      command: helm upgrade --install grafana grafana/grafana --create-namespace --kubeconfig /home/ubuntu/.kube/config

    - name: Get Prometheus server pod name
      command: kubectl get pods -n default -l app=prometheus-server -o jsonpath="{.items[0].metadata.name}" --kubeconfig /home/ubuntu/.kube/config
      register: prometheus_pod_name

    - name: Get Grafana server pod name
      command: kubectl get pods -n default -l app=grafana -o jsonpath="{.items[0].metadata.name}" --kubeconfig /home/ubuntu/.kube/config
      register: grafana_pod_name

    - name: Port forward Prometheus to public IP
      command: kubectl port-forward --address 0.0.0.0 {{ prometheus_pod_name.stdout }} 9090:9090 --kubeconfig /home/ubuntu/.kube/config
      async: 0
      poll: 0
      register: prometheus_port_forward
      ignore_errors: true

    - name: Port forward Grafana to public IP
      command: kubectl port-forward --address 0.0.0.0 {{ grafana_pod_name.stdout }} 3000:3000 --kubeconfig /home/ubuntu/.kube/config
      async: 0
      poll: 0
      register: grafana_port_forward
      ignore_errors: true

    - name: Wait for port forwarding to start
      pause:
        seconds: 5
